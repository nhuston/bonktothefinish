var races = <%= processed_races_info().to_json %>;
console.log(races);



// Set the dimensions of the canvas / graph
var margin = {
        top: 30,
        right: 20,
        bottom: 30,
        left: 50
    },
    width = 600 - margin.left - margin.right,
    height = 270 - margin.top - margin.bottom;

// set the dimensions and margins of the graph
var margin = {
        top: 20,
        right: 20,
        bottom: 30,
        left: 50
    },
    width = 960 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;

// parse the date / time
var parseDate = d3.timeParse("%Y-%m-%d");


// preprocess/format the data
for(race_name in races){
	for(race of races[race_name]){
		race.date = parseDate(race.date);
		race.time = (race.time);
	}
}

document.addEventListener("DOMContentLoaded", function(e) {
	// append the svg obgect to the body of the page
	// appends a 'group' element to 'svg'
	// moves the 'group' element to the top left margin
	var svg = d3.select("body").append("svg")
		.attr("width", width + margin.left + margin.right)
		.attr("height", height + margin.top + margin.bottom)
		.append("g")
		.attr("transform",
			"translate(" + margin.left + "," + margin.top + ")");
	create_scatter_plot(svg, races["5K"]);
  });

function format_duration(d) {
    var hours = Math.floor(d / 3600),
        minutes = Math.floor((d - (hours * 3600)) / 60),
        seconds = d - (minutes * 60);
    var output = seconds + 's';
    if (minutes) {
        output = minutes + 'm ' + output;
    }
    if (hours) {
        output = hours + 'h ' + output;
    }
    return output;
}

function create_scatter_plot(svg, data){
	var get_x = function(d){ return d.date;}
	var get_y = function(d){ return d.time;}

	// set the ranges
	var x = d3.scaleTime()
		.range([0, width])
		.domain(d3.extent(data, get_x));
	var y = d3.scaleLinear()
		.range([height, 0])
		.domain([d3.min(data, get_y), d3.max(data, get_y)]);

	var get_axis_x = function(d){ return x(get_x(d));}
	var get_axis_y = function(d){ return y(get_y(d));}

	// define the line
	var valueline = d3.line()
		.x(get_axis_x)
		.y(get_axis_y);

	// Add the valueline path.
	svg.append("path")
	.data([data])
	.attr("class", "line")
	.attr("d", valueline);

	// Add the scatterplot
	svg.selectAll("dot")
	.data(data)
	.enter().append("circle")
	.attr("r", 5)
	.attr("cx", get_axis_x)
	.attr("cy", get_axis_y);

	// Add the X Axis
	svg.append("g")
	.attr("transform", "translate(0," + height + ")")
	.call(d3.axisBottom(x));

	// Add the Y Axis
	svg.append("g")
	.call(
		d3.axisLeft(y)
		.tickFormat(format_duration)
	);
}
